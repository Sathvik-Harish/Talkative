<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talkative</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #36393f;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }
        .message-actions {
            display: none;
        }
        .message-container:hover .message-actions {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-700 text-gray-200 h-full flex flex-col">

    <div id="loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="flex items-center space-x-2 text-white">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Loading Chat...</span>
        </div>
    </div>

    <div id="name-modal" class="hidden absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-40">
        <div class="bg-gray-700 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-white">Choose Your Name</h2>
            <form id="name-form">
                <input type="text" id="name-input" placeholder="Enter your name" class="w-full bg-gray-800 rounded-lg px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                    Set Name
                </button>
            </form>
        </div>
    </div>
    
    <div id="edit-modal" class="hidden absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-40">
        <div class="bg-gray-700 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-white">Edit Message</h2>
            <form id="edit-form">
                <textarea id="edit-input" class="w-full bg-gray-800 rounded-lg px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required></textarea>
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">Save</button>
                </div>
            </form>
        </div>
    </div>

    <header class="bg-gray-800 p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold text-white">Talkative</h1>
        <div id="user-info" class="text-xs text-gray-400 flex items-center"></div>
    </header>

    <main id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-1 bg-gray-700">
    </main>

    <footer class="p-4 bg-gray-800">
        <form id="message-form" class="flex items-center space-x-4">
            <input type="text" id="message-input" placeholder="Message in #general" class="flex-1 bg-gray-600 rounded-lg px-4 py-2 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                Send
            </button>
        </form>
    </footer>

    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('error');

        const loadingOverlay = document.getElementById('loading-overlay');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const userInfo = document.getElementById('user-info');
        
        const nameModal = document.getElementById('name-modal');
        const nameForm = document.getElementById('name-form');
        const nameInput = document.getElementById('name-input');

        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editInput = document.getElementById('edit-input');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        let currentUserId = null;
        let currentUserName = 'Anonymous';
        let messagesUnsubscribe = null;
        let editingMessageId = null;

        function formatTimestamp(firebaseTimestamp) {
            if (!firebaseTimestamp) return '';
            const date = firebaseTimestamp.toDate();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function createMessageElement(doc) {
            const data = doc.data();
            const messageId = doc.id;

            const messageContainer = document.createElement('div');
            messageContainer.id = messageId;
            messageContainer.className = 'message-container flex items-start space-x-4 p-2 rounded-md hover:bg-gray-600/50';

            const avatar = document.createElement('div');
            avatar.className = 'w-10 h-10 rounded-full bg-gray-800 flex-shrink-0';
            
            const content = document.createElement('div');
            content.className = 'flex-1';

            const header = document.createElement('div');
            header.className = 'flex items-baseline space-x-2';
            
            const author = document.createElement('span');
            author.className = 'font-bold text-white';
            author.textContent = data.authorName || 'Anonymous';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'text-xs text-gray-400';
            timestamp.textContent = formatTimestamp(data.timestamp);

            header.appendChild(author);
            header.appendChild(timestamp);

            const text = document.createElement('p');
            text.className = 'text-gray-300 whitespace-pre-wrap';
            text.textContent = data.text;
            
            if (data.edited) {
                const editedSpan = document.createElement('span');
                editedSpan.className = 'text-xs text-gray-400 ml-1'
                editedSpan.textContent = '(edited)';
                text.appendChild(editedSpan);
            }

            content.appendChild(header);
            content.appendChild(text);
            
            messageContainer.appendChild(avatar);
            messageContainer.appendChild(content);

            if (data.authorId === currentUserId) {
                const actions = document.createElement('div');
                actions.className = 'message-actions space-x-2';

                const editBtn = document.createElement('button');
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.className = 'edit-btn text-xs bg-gray-500 hover:bg-gray-400 p-1 rounded';
                editBtn.dataset.id = messageId;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.className = 'delete-btn text-xs bg-red-800 hover:bg-red-700 p-1 rounded';
                deleteBtn.dataset.id = messageId;

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                messageContainer.appendChild(actions);
            }

            return messageContainer;
        }

        function handleDocChange(change) {
            const doc = change.doc;
            const messageId = doc.id;

            if (change.type === "added") {
                const messageElement = createMessageElement(doc);
                chatMessages.appendChild(messageElement);
                if (chatMessages.scrollHeight - chatMessages.scrollTop < chatMessages.clientHeight + 200) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            if (change.type === "modified") {
                const existingElement = document.getElementById(messageId);
                if (existingElement) {
                    const newElement = createMessageElement(doc);
                    existingElement.replaceWith(newElement);
                }
            }
            if (change.type === "removed") {
                const elementToRemove = document.getElementById(messageId);
                if (elementToRemove) {
                    elementToRemove.remove();
                }
            }
        }

        async function setupMessageListener() {
            if (messagesUnsubscribe) messagesUnsubscribe();
            
            const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
            const q = query(messagesRef);

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const sortedChanges = snapshot.docChanges().sort((a, b) => {
                    const timeA = a.doc.data().timestamp?.toMillis() || 0;
                    const timeB = b.doc.data().timestamp?.toMillis() || 0;
                    return timeA - timeB;
                });
                sortedChanges.forEach(handleDocChange);
            }, (error) => console.error("Error fetching messages: ", error));
        }

        async function loadUserProfile(userId) {
            try {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    currentUserName = userSnap.data().displayName;
                } else {
                    nameModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Could not fetch user profile:", error);
                currentUserName = 'Anonymous';
            } finally {
                updateUserInfo();
                await setupMessageListener();
                loadingOverlay.style.display = 'none';
            }
        }

        function updateUserInfo() {
            userInfo.innerHTML = `
                <span>Logged in as: <strong class="text-white">${currentUserName}</strong></span>
                <button id="change-name-btn" class="ml-4 text-blue-400 hover:underline text-xs">[Change Name]</button>
            `;
            document.getElementById('change-name-btn').addEventListener('click', () => {
                nameInput.value = currentUserName;
                nameModal.classList.remove('hidden');
            });
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && currentUserId) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/messages`), {
                        text: text,
                        authorId: currentUserId,
                        authorName: currentUserName,
                        timestamp: serverTimestamp(),
                        edited: false
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error sending message: ", error);
                }
            }
        });

        nameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = nameInput.value.trim();
            if (newName && currentUserId) {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUserId);
                await setDoc(userRef, { displayName: newName });
                currentUserName = newName;
                updateUserInfo();
                nameModal.classList.add('hidden');
            }
        });

        chatMessages.addEventListener('click', async (e) => {
            if (e.target.matches('.delete-btn')) {
                const messageId = e.target.dataset.id;
                const messageRef = doc(db, `artifacts/${appId}/public/data/messages`, messageId);
                await deleteDoc(messageRef);
            }
            if (e.target.matches('.edit-btn')) {
                editingMessageId = e.target.dataset.id;
                const messageElement = document.getElementById(editingMessageId);
                const currentText = messageElement.querySelector('p').childNodes[0].textContent;
                editInput.value = currentText;
                editModal.classList.remove('hidden');
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newText = editInput.value.trim();
            if (newText && editingMessageId) {
                const messageRef = doc(db, `artifacts/${appId}/public/data/messages`, editingMessageId);
                await updateDoc(messageRef, {
                    text: newText,
                    edited: true
                });
                editModal.classList.add('hidden');
                editingMessageId = null;
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
            editingMessageId = null;
        });

        onAuthStateChanged(auth, async (user) => {
            if (user && !currentUserId) {
                currentUserId = user.uid;
                await loadUserProfile(user.uid);
            } else if (!user) {
                try {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    loadingOverlay.innerHTML = '<span>Authentication Failed. Please refresh.</span>';
                }
            }
        });
    </script>
</body>
</html>
